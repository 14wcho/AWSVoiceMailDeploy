!function(e,t){for(var o in t)e[o]=t[o]}(exports,function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=879)}({15:function(e,t){e.exports=require("url")},16:function(e,t){e.exports=require("fs")},19:function(e,t){e.exports=require("uuid")},3:function(e,t){e.exports=require("aws-sdk")},8:function(e,t){e.exports=require("https")},879:function(e,t,o){"use strict";console.log("Loading function");const r=o(8),n=o(15);o(19);let s=o(3),c=new s.S3;o(16);new s.APIGateway;t.handler=(e,t,o)=>{console.log("Event: "+JSON.stringify(e));let r="FAILED",n={};"Create"===e.RequestType?"copyObjects"===e.ResourceProperties.customAction?f(e.ResourceProperties.SourceBucket,e.ResourceProperties.DestBucket,e.ResourceProperties.Prefix,e.ResourceProperties.Objects,0,(function(s,c){s?(n={Error:"Copy objects function failed"},console.log([n.Error,":\n",s].join(""))):(r="SUCCESS",n={}),u(e,o,t.logStreamName,r,n)})):"cleanUpS3Bucket"===e.ResourceProperties.customAction&&(r="SUCCESS",n={},u(e,o,t.logStreamName,r,n)):"Delete"===e.RequestType?("cleanUpS3Bucket"===e.ResourceProperties.customAction&&i(e.ResourceProperties,(function(s,c){s?(n={Error:"Clean up S3 bucket function failed"},console.log([n.Error,":\n",s].join(""))):(r="SUCCESS",n={}),u(e,o,t.logStreamName,r,n)})),r="SUCCESS",u(e,o,t.logStreamName,r,n)):"copyObjects"===e.ResourceProperties.customAction&&l(e.ResourceProperties.DestBucket,(function(s,c){s?(n={Error:"Delete objects function failed"},console.log([n.Error,":\n",s].join(""))):(r="SUCCESS",n={}),u(e,o,t.logStreamName,r,n)}))};let u=function(e,t,o,s,c){const u=JSON.stringify({Status:s,Reason:`See the details in CloudWatch Log Stream: ${o}`,PhysicalResourceId:o,StackId:e.StackId,RequestId:e.RequestId,LogicalResourceId:e.LogicalResourceId,Data:c}),i=n.parse(e.ResponseURL),l={hostname:i.hostname,port:443,path:i.path,method:"PUT",headers:{"Content-Type":"","Content-Length":u.length}},a=r.request(l,e=>{t(null,"Successfully sent stack response!")});a.on("error",e=>{console.log("sendResponse Error:\n",e),t(e)}),a.write(u),a.end()},i=function(e,t){var o={Bucket:e.DestBucket};c.getBucketVersioning(o,(function(o,r){return o?(console.log("Error getting the bucket version: "+o),t(o,null)):(r.Status?(console.log("This is a versioned Bucket"),l(e.DestBucket,t)):(console.log("This is not a versioned bucket"),a(e.DestBucket,t)),t(null,"success"))}))},l=function(e,t){var o={Bucket:e};c.listObjectVersions(o,(function(o,r){if(o)console.log("error listing bucket objects "+o);else{for(var n=[],s=r.Versions,u=0;u<s.length;u+=1)n.push({Key:s[u].Key,VersionId:s[u].VersionId});var i=r.DeleteMarkers;for(u=0;u<i.length;u+=1)n.push({Key:i[u].Key,VersionId:i[u].VersionId});var l={Bucket:e,Delete:{Objects:n}};c.deleteObjects(l,(function(e,o){if(e)return console.log("error deleting objects "+e),t(e,null);t(null,"success")}))}}))},a=function(e,t){var o={Bucket:e};c.listObjects(o,(function(e,o){if(e)console.log("error listing bucket objects "+e);else{for(var r=o.Contents,n=[],s=0;s<r.length;s+=1)n.push({Key:r[s].Key});var u={Bucket:bucket,Objects:n};c.deleteObjects(u,(function(e,o){if(e)return console.log("error deleting objects "+e),t(e,null);t(null,"success")}))}}))},f=function(e,t,o,r,n,s){if(r.length>n){let u="aws-connect-vm-serverless/"+r[n],i={CopySource:e+"/"+o+r[n],Bucket:t,Key:u};c.copyObject(i,(function(c,u){c&&console.log("Error copying file: "+c),f(e,t,o,r,n+1,(function(e,t){if(e)return s(e,null);s(null,t)}))}))}else s(null,[n,"files copied"].join(" "))}}}));
//# sourceMappingURL=copy-artifacts-helper.js.map