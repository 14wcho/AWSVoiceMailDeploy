!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=883)}({10:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n(4),s=n(5);class i{constructor(){this.dynamo=new r.a(process.env.USERS_TABLE_NAME),this.amazonConnectInstanceId=process.env.AMAZON_CONNECT_INSTANCE_ARN}getAgentByExtension(e){let t={IndexName:"AgentExtensionIndex",KeyConditionExpression:"extension = :ext",ExpressionAttributeValues:{":ext":e}};return this.dynamo.query(t).then(e=>e.length>0?new s.a(e[0]):null)}getAgentByUserId(e){let t={Key:{agentId:e}};return this.dynamo.getItem(t).then(e=>e?new s.a(e):null)}getAgents(e,t){let n={Limit:t||1e3,Select:"ALL_ATTRIBUTES"};return e&&(n.ExclusiveStartKey=JSON.parse(Buffer.from(e,"base64").toString("utf-8"))),this.dynamo.scanWithNext(n)}getAllAgents(){return this.dynamo.scan({Select:"ALL_ATTRIBUTES"})}createAgentCreateParam(e){let t={Item:{...e,agentId:e.userId}};return""===e.extension&&delete t.Item.extension,t}createAgentDeleteParam(e){return{Key:{agentId:e.userId}}}createAgent(e){let t=this.createAgentData(e);return this.dynamo.put(t)}updateAgentById(e,{extension:t,deliverSMSPhoneNumber:n,deliverSMS:r,deliverEmail:s,encryptVoicemail:i,transcribeVoicemail:o}){let a={":tv":o||!1,":ev":i||!1,":de":s,":do":{email:s,sms:{enabled:r,phoneNumber:""===n?"null":n}}};null!==t&&""!==t&&(a[":ext"]=t);let u="SET transcribeVoicemail=:tv, encryptVoicemail = :ev, deliveryEmail = :de, deliveryOptions = :do";u+=null===t||""===t?" REMOVE extension":", extension = :ext";let c={Key:{agentId:e},ExpressionAttributeValues:a,UpdateExpression:u};return this.dynamo.update(c)}batchWrite(e){return this.dynamo.batchWrite(e,0)}}},12:function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));class r{constructor(e,t){this.userId=e.userId,this.agent=e,this.connectUser=t}}var s=n(2),i=n(5);s.a;class o extends s.a{constructor(e){super("ExtensionInUseError","Extension already in use. Please provide a different extension number.",`Cannot have more than one user assigned to the extension number: ${e}`)}}var a=n(9),u=n.n(a);class c{constructor(e,t){this.usersRepo=t,this.connectService=e}getConnectAgentByExtension(e){return this.usersRepo.getAgentByExtension(e).then(e=>this.connectService.getConnectUser(e.userId).then(t=>new r(e,t)))}getConnectAgentByUserId(e){return this.connectService.getConnectUser(e).then(t=>this.usersRepo.getAgentByUserId(e).then(e=>new r(e,t)))}getConnectAgents(e,t){return this.usersRepo.getAgents(e,t)}syncConnectAgents(){return Promise.all([this.connectService.listConnectUsers(),this.usersRepo.getAllAgents()]).then(e=>{let[t,n]=e,r=[];if(t.forEach(e=>{const t=n.find(t=>t.userId===e.Id);let s;t&&t.username!==e.Username?(s={...t,username:e.Username},r.push({PutRequest:this.usersRepo.createAgentCreateParam(s)})):t||(s={userId:e.Id,username:e.Username},r.push({PutRequest:this.usersRepo.createAgentCreateParam(s)}))}),n.forEach(e=>{t.find(t=>t.Id===e.userId)||r.push({DeleteRequest:this.usersRepo.createAgentDeleteParam(e)})}),r.length>0)return this.usersRepo.batchWrite(r)})}updateAgentById(e,t){return this._validateAgentUpdate(e,t).then(()=>this.createAgentIfNeeded(e,t.extension)).then(()=>this.usersRepo.updateAgentById(e,t)).then(()=>this.getConnectAgentByUserId(e))}createAgentIfNeeded(e,t){let n=this.usersRepo.getAgentByUserId(e).then(n=>null===n?this.usersRepo.createAgent(i.a.create(e,t)):n);return t?this.usersRepo.getAgentByExtension(t).then(n=>{if(null!=n&&n.userId!==e)throw new o(t);return n}).then(()=>n):n}_validateAgentUpdate(e,t){return new Promise((n,r)=>{let{extension:i,deliverSMSPhoneNumber:o,deliverSMS:a,deliverEmail:c,encryptVoicemail:l,transcribeVoicemail:d}=t;if(e)if(!0!==a||void 0!==o&&""!==o){if(o){let e=new u.a(o);e.isValid()?t.deliverSMSPhoneNumber=e.getNumber():r(new s.a("InvalidPhoneNumberError","The phone number you've entered is invalid.  Please enter a valid phone number and try again.",`Phone number cannot be validated for ${o}`))}t.hasOwnProperty("extension")&&(t.extension.length>5||Number.isNaN(t.extension))?r(new s.b("Invalid extension number","Extension number must be numeric and less than 5 digits.")):t.hasOwnProperty("extension")&&t.hasOwnProperty("deliverSMS")&&t.hasOwnProperty("deliverEmail")&&t.hasOwnProperty("transcribeVoicemail")&&t.hasOwnProperty("encryptVoicemail")?n({agentId:e,update:t}):r(new s.d)}else r(new s.b("Please provide a phone number for SMS delivery","deliverSMSPhoneNumber cannot be null or empty if deliverSMS is true"));else r(new s.c("agentId"))})}}},13:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class r{constructor(e,t=!0){this.userId=e.Id,this.arn=e.Arn,this.username=e.Username,t&&(this.firstName=e.IdentityInfo.FirstName,this.lastName=e.IdentityInfo.LastName,this.email=e.IdentityInfo.Email,e.hasOwnProperty("PhoneConfig")?(this.phoneType=e.PhoneConfig.PhoneType,this.autoAccept=e.PhoneConfig.AutoAccept,this.deskPhoneNumber=e.PhoneConfig.DeskPhoneNumber):(this.phoneType=null,this.autoAccept=null,this.deskPhoneNumber=null),this.directoryUserId=e.DirectoryUserId,this.routingProfileId=e.RoutingProfileId)}getFullName(){return`${this.firstName} ${this.lastName}`}}const s=n(3);class i{constructor(){this.instanceId=process.env.AMAZON_CONNECT_INSTANCE_ARN.split("/")[1],this.connect=new s.Connect,this.maxBackOffTime=30}getConnectUsers(){return this.listConnectUsers().then(e=>{let t=e.map(e=>this.getConnectUser(e.Id));return Promise.all(t)})}getConnectUser(e){return new Promise((t,n)=>{let s={InstanceId:this.instanceId,UserId:e};this.connect.describeUser(s,(e,s)=>e?(console.log("Error",e),void n(e)):s?void t(new r(s.User)):(console.log("No user found"),void n(e)))})}listConnectUsers(){return this._listConnectUsers([],null,0)}_listConnectUsers(e,t,n){let r={InstanceId:this.instanceId,MaxResults:100};return t&&(r.NextToken=t),this.connect.listUsers(r).promise().then(t=>{let{UserSummaryList:n,NextToken:r}=t,s=e.concat(n);return r?this._listConnectUsers(s,r,0):s}).catch(e=>{if(console.warn("list connect user failed",e),n>5)throw e;return(r=Math.min(Math.pow(n,2),this.maxBackOffTime),new Promise(e=>setTimeout(e,r))).then(()=>{this._listConnectUsers(users,t,n+1)});var r})}}},2:function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"c",(function(){return s})),n.d(t,"b",(function(){return i})),n.d(t,"d",(function(){return o}));class r extends Error{constructor(e,t,n){super(),this.message=t,this.developerMessage=n,this.name=e}}class s extends r{constructor(e){super("MissingParameterError","Missing parameter",`Missing parameter: ${e}`)}}class i extends r{constructor(e,t){super("InvalidParameterValueError",e,t)}}class o extends r{constructor(){super("MissingParametersError","One or more parameters are missing","You have one ore more parameters miss, please see documentation for more information.")}}},20:function(e,t,n){const r=n(8);class s{static get Constants(){return{Host:"metrics.awssolutionsbuilder.com",Path:"/generic"}}static async sendAnonymousData(e,t){return new Promise((n,i)=>{const o=Object.assign({Solution:process.env.SOLUTION_ID,UUID:process.env.UUID,TimeStamp:(new Date).toISOString().replace("T"," ").replace("Z",""),Data:e},t);o.Data&&o.Solution&&o.UUID||n(void 0);const a=[],u={hostname:s.Constants.Host,port:443,path:s.Constants.Path,method:"POST",headers:{"Content-Type":"application/json"}},c=r.request(u,e=>{e.on("data",e=>a.push(e)),e.on("end",()=>{e.statusCode>=400?i(new Error(`${e.statusCode} ${e.statusMessage} ${u.hostname}`)):n(Buffer.concat(a))})});c.write(JSON.stringify(o)),c.on("error",e=>i(e)),c.end(),console.log("successfully sent metrics")})}}e.exports={Metrics:s}},3:function(e,t){e.exports=require("aws-sdk")},31:function(e,t){e.exports=require("source-map-support/register")},4:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));const r=n(3);class s{constructor(e){this.tableName=e,this.client=new r.DynamoDB.DocumentClient}update(e){return e.TableName=this.tableName,e.ReturnValues="ALL_NEW",this.client.update(e).promise()}put(e){return e.TableName=this.tableName,this.client.put(e).promise()}query(e){return e.TableName=this.tableName,this.client.query(e).promise().then(e=>e.Items||null)}scan(e){return e.TableName=this.tableName,this.client.scan(e).promise().then(e=>e.Items||null)}queryWithNext(e){return e.TableName=this.tableName,this.client.query(e).promise().then(e=>{let t={data:e.Items||[]};return e.LastEvaluatedKey&&(t.next=Buffer.from(JSON.stringify(e.LastEvaluatedKey),"utf8").toString("base64")),t})}scanWithNext(e){return e.TableName=this.tableName,this.client.scan(e).promise().then(e=>{let t={data:e.Items||[]};return e.LastEvaluatedKey&&(t.next=Buffer.from(JSON.stringify(e.LastEvaluatedKey),"utf8").toString("base64")),t})}getItem(e,t){return e.TableName=this.tableName,this.client.get(e).promise().then(e=>e.Item||null)}batchWrite(e,t){return new Promise((n,r)=>{this._batchWrite(e,t).then(t=>{e.length>t.index?this.batchWrite(e,t.index).then(e=>{n(e)}):n(t.data)})})}_batchWrite(e,t){return new Promise((n,r)=>{let s=e.length>t+24?t+24:e.length,i=e.slice(t,s),o={RequestItems:{[this.tableName]:i}};this.client.batchWrite(o,(e,r)=>{e&&console.log("Any error? "+JSON.stringify(e,null,2)),n({index:t+24,data:r})})})}}},5:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));class r{constructor(e){this.userId=e.userId,this.extension=e.extension,this.username=e.username,this.transcribeVoicemail=e.transcribeVoicemail||!1,this.encryptVoicemail=e.encryptVoicemail||!1,this.deliveryOptions=e.deliveryOptions||{sms:{enabled:!1,phoneNumber:null},email:!1}}static create(e,t=null){return new r({userId:e,extension:t,deliveryOptions:{sms:{enabled:!1,phoneNumber:null},email:!1}})}}},6:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));const r={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":!0,"Strict-Transport-Security":"max-age=31536000; includeSubDomains","X-Frame-Options":"DENY"};const s={Response:function(e,t={},n=!1,s=null){let i={statusCode:e,body:JSON.stringify(t)};if(n&&(i.headers=r),s){let e=i.headers;e={...e,...s},i.headers=e}return i},Error:function e(t,n,s,i=!1){console.log(n,n instanceof e,n.toString());let o="",a="Error",u="",c="";n.hasOwnProperty("message")&&(o=n.message),n.hasOwnProperty("name")&&(a=n.name),n.hasOwnProperty("stack")&&(u=n.stack),n.hasOwnProperty("developerMessage")&&(c=n.developerMessage);let l={statusCode:t,body:JSON.stringify({errorMessage:s})};return i&&(l.headers=r),console.log("Error:",l),l}}},8:function(e,t){e.exports=require("https")},883:function(e,t,n){"use strict";n.r(t);n(31);var r=n(12),s=n(13),i=n(10),o=n(6),a=n(20);const u=new r.a(new s.a,new i.a);function c(e,t){a.Metrics.sendAnonymousData({uuid:process.env.UUID,process:"sync",status:e,details:t||""}).catch(e=>console.log(`sendAnonymous: ${e.message}`))}exports.syncHandler=(e,t)=>u.syncConnectAgents().then(e=>{c("Success")}).catch(e=>{c("Failure",o.a.Error(400,e,"Unable to sync agents",!0))}),exports.syncRequestHandler=(e,t)=>u.syncConnectAgents().then(e=>(c("Success"),o.a.Response(200,{},!0))).catch(e=>{console.log("returning a 400: "+JSON.stringify(e));let t=o.a.Error(400,e,"Unable to sync agents",!0);return c("Failure",t),t})},9:function(e,t){e.exports=require("awesome-phonenumber")}}));
//# sourceMappingURL=sync-vm-connect.js.map