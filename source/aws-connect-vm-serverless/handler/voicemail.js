!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=885)}({10:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n(4),s=n(5);class i{constructor(){this.dynamo=new r.a(process.env.USERS_TABLE_NAME),this.amazonConnectInstanceId=process.env.AMAZON_CONNECT_INSTANCE_ARN}getAgentByExtension(e){let t={IndexName:"AgentExtensionIndex",KeyConditionExpression:"extension = :ext",ExpressionAttributeValues:{":ext":e}};return this.dynamo.query(t).then(e=>e.length>0?new s.a(e[0]):null)}getAgentByUserId(e){let t={Key:{agentId:e}};return this.dynamo.getItem(t).then(e=>e?new s.a(e):null)}getAgents(e,t){let n={Limit:t||1e3,Select:"ALL_ATTRIBUTES"};return e&&(n.ExclusiveStartKey=JSON.parse(Buffer.from(e,"base64").toString("utf-8"))),this.dynamo.scanWithNext(n)}getAllAgents(){return this.dynamo.scan({Select:"ALL_ATTRIBUTES"})}createAgentCreateParam(e){let t={Item:{...e,agentId:e.userId}};return""===e.extension&&delete t.Item.extension,t}createAgentDeleteParam(e){return{Key:{agentId:e.userId}}}createAgent(e){let t=this.createAgentData(e);return this.dynamo.put(t)}updateAgentById(e,{extension:t,deliverSMSPhoneNumber:n,deliverSMS:r,deliverEmail:s,encryptVoicemail:i,transcribeVoicemail:o}){let a={":tv":o||!1,":ev":i||!1,":de":s,":do":{email:s,sms:{enabled:r,phoneNumber:""===n?"null":n}}};null!==t&&""!==t&&(a[":ext"]=t);let c="SET transcribeVoicemail=:tv, encryptVoicemail = :ev, deliveryEmail = :de, deliveryOptions = :do";c+=null===t||""===t?" REMOVE extension":", extension = :ext";let l={Key:{agentId:e},ExpressionAttributeValues:a,UpdateExpression:c};return this.dynamo.update(l)}batchWrite(e){return this.dynamo.batchWrite(e,0)}}},11:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));class r{constructor(e){this.globalRepo=e}getSettings(){return this.globalRepo.getGlobalSettings()}update(e,t,n,r){return this.globalRepo.updateGlobalSettings(e,t,n,r).then(e=>{console.log("Result: "+JSON.stringify(e));let{transcribeVoicemail:t,encryptVoicemail:n,deliveryEmail:r,availableSMSCountries:s}=e.Attributes;return{transcribeVoicemail:t,encryptVoicemail:n,deliveryEmail:r,availableSMSCountries:s}})}createDefault(){return this.globalRepo.createGlobalSettings(!0,!0,process.env.DELIVERY_EMAIL)}}},12:function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));class r{constructor(e,t){this.userId=e.userId,this.agent=e,this.connectUser=t}}var s=n(2),i=n(5);s.a;class o extends s.a{constructor(e){super("ExtensionInUseError","Extension already in use. Please provide a different extension number.",`Cannot have more than one user assigned to the extension number: ${e}`)}}var a=n(9),c=n.n(a);class l{constructor(e,t){this.usersRepo=t,this.connectService=e}getConnectAgentByExtension(e){return this.usersRepo.getAgentByExtension(e).then(e=>this.connectService.getConnectUser(e.userId).then(t=>new r(e,t)))}getConnectAgentByUserId(e){return this.connectService.getConnectUser(e).then(t=>this.usersRepo.getAgentByUserId(e).then(e=>new r(e,t)))}getConnectAgents(e,t){return this.usersRepo.getAgents(e,t)}syncConnectAgents(){return Promise.all([this.connectService.listConnectUsers(),this.usersRepo.getAllAgents()]).then(e=>{let[t,n]=e,r=[];if(t.forEach(e=>{const t=n.find(t=>t.userId===e.Id);let s;t&&t.username!==e.Username?(s={...t,username:e.Username},r.push({PutRequest:this.usersRepo.createAgentCreateParam(s)})):t||(s={userId:e.Id,username:e.Username},r.push({PutRequest:this.usersRepo.createAgentCreateParam(s)}))}),n.forEach(e=>{t.find(t=>t.Id===e.userId)||r.push({DeleteRequest:this.usersRepo.createAgentDeleteParam(e)})}),r.length>0)return this.usersRepo.batchWrite(r)})}updateAgentById(e,t){return this._validateAgentUpdate(e,t).then(()=>this.createAgentIfNeeded(e,t.extension)).then(()=>this.usersRepo.updateAgentById(e,t)).then(()=>this.getConnectAgentByUserId(e))}createAgentIfNeeded(e,t){let n=this.usersRepo.getAgentByUserId(e).then(n=>null===n?this.usersRepo.createAgent(i.a.create(e,t)):n);return t?this.usersRepo.getAgentByExtension(t).then(n=>{if(null!=n&&n.userId!==e)throw new o(t);return n}).then(()=>n):n}_validateAgentUpdate(e,t){return new Promise((n,r)=>{let{extension:i,deliverSMSPhoneNumber:o,deliverSMS:a,deliverEmail:l,encryptVoicemail:u,transcribeVoicemail:d}=t;if(e)if(!0!==a||void 0!==o&&""!==o){if(o){let e=new c.a(o);e.isValid()?t.deliverSMSPhoneNumber=e.getNumber():r(new s.a("InvalidPhoneNumberError","The phone number you've entered is invalid.  Please enter a valid phone number and try again.",`Phone number cannot be validated for ${o}`))}t.hasOwnProperty("extension")&&(t.extension.length>5||Number.isNaN(t.extension))?r(new s.b("Invalid extension number","Extension number must be numeric and less than 5 digits.")):t.hasOwnProperty("extension")&&t.hasOwnProperty("deliverSMS")&&t.hasOwnProperty("deliverEmail")&&t.hasOwnProperty("transcribeVoicemail")&&t.hasOwnProperty("encryptVoicemail")?n({agentId:e,update:t}):r(new s.d)}else r(new s.b("Please provide a phone number for SMS delivery","deliverSMSPhoneNumber cannot be null or empty if deliverSMS is true"));else r(new s.c("agentId"))})}}},13:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class r{constructor(e,t=!0){this.userId=e.Id,this.arn=e.Arn,this.username=e.Username,t&&(this.firstName=e.IdentityInfo.FirstName,this.lastName=e.IdentityInfo.LastName,this.email=e.IdentityInfo.Email,e.hasOwnProperty("PhoneConfig")?(this.phoneType=e.PhoneConfig.PhoneType,this.autoAccept=e.PhoneConfig.AutoAccept,this.deskPhoneNumber=e.PhoneConfig.DeskPhoneNumber):(this.phoneType=null,this.autoAccept=null,this.deskPhoneNumber=null),this.directoryUserId=e.DirectoryUserId,this.routingProfileId=e.RoutingProfileId)}getFullName(){return`${this.firstName} ${this.lastName}`}}const s=n(3);class i{constructor(){this.instanceId=process.env.AMAZON_CONNECT_INSTANCE_ARN.split("/")[1],this.connect=new s.Connect,this.maxBackOffTime=30}getConnectUsers(){return this.listConnectUsers().then(e=>{let t=e.map(e=>this.getConnectUser(e.Id));return Promise.all(t)})}getConnectUser(e){return new Promise((t,n)=>{let s={InstanceId:this.instanceId,UserId:e};this.connect.describeUser(s,(e,s)=>e?(console.log("Error",e),void n(e)):s?void t(new r(s.User)):(console.log("No user found"),void n(e)))})}listConnectUsers(){return this._listConnectUsers([],null,0)}_listConnectUsers(e,t,n){let r={InstanceId:this.instanceId,MaxResults:100};return t&&(r.NextToken=t),this.connect.listUsers(r).promise().then(t=>{let{UserSummaryList:n,NextToken:r}=t,s=e.concat(n);return r?this._listConnectUsers(s,r,0):s}).catch(e=>{if(console.warn("list connect user failed",e),n>5)throw e;return(r=Math.min(Math.pow(n,2),this.maxBackOffTime),new Promise(e=>setTimeout(e,r))).then(()=>{this._listConnectUsers(users,t,n+1)});var r})}}},14:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n(4);class s{constructor(e){this.transcribeVoicemail=e.transcribeVoicemail||!1,this.encryptVoicemail=e.encryptVoicemail||!1,this.deliveryEmail=e.deliveryEmail||null,this.availableSMSCountries=e.availableSMSCountries||(process.env.AVAILABLE_SMS_COUNTRIES||"").split(",")}}class i{constructor(){this.dynamo=new r.a(process.env.GLOBAL_TABLE_NAME),this.amazonConnectInstanceArn=process.env.AMAZON_CONNECT_INSTANCE_ARN}getGlobalSettings(){console.log("Getting Global Settings");let e={Key:{instanceArn:this.amazonConnectInstanceArn}};return this.dynamo.getItem(e).then(e=>e?new s(e):null)}createGlobalSettings(e,t,n,r){let i=new s({transcribeVoicemail:e,encryptVoicemail:t,deliveryEmail:n,availableSMSCountries:r});i.instanceArn=this.amazonConnectInstanceArn;let o={Item:i};return console.log("dynamo put"),this.dynamo.put(o).then(()=>i)}updateGlobalSettings(e,t,n,r){return this.getGlobalSettings().then(s=>s?this._updateGlobalSettings(e,t,n,r):(console.log("in create"),this.createGlobalSettings(e,t,n,r)))}_updateGlobalSettings(e,t,n,r){let s={Key:{instanceArn:this.amazonConnectInstanceArn},ExpressionAttributeValues:{":tv":e,":ev":t,":de":n,":ac":r},UpdateExpression:"SET transcribeVoicemail=:tv, encryptVoicemail=:ev, deliveryEmail=:de, availableSMSCountries=:ac"};return this.dynamo.update(s)}}},2:function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"c",(function(){return s})),n.d(t,"b",(function(){return i})),n.d(t,"d",(function(){return o}));class r extends Error{constructor(e,t,n){super(),this.message=t,this.developerMessage=n,this.name=e}}class s extends r{constructor(e){super("MissingParameterError","Missing parameter",`Missing parameter: ${e}`)}}class i extends r{constructor(e,t){super("InvalidParameterValueError",e,t)}}class o extends r{constructor(){super("MissingParametersError","One or more parameters are missing","You have one ore more parameters miss, please see documentation for more information.")}}},21:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var r=n(4);class s{constructor(){this.dynamo=new r.a(process.env.CONTACT_VOICEMAIL_TABLE_NAME)}updateTranscriptionStatus(e,t,n){let r={KeyConditionExpression:"contactId = :contactId",ExpressionAttributeValues:{":contactId":e}};return Promise.all([this.dynamo.query(r)]).then(t=>{let r=[];return t[0].map(t=>{let s={Key:{contactId:e,readerId:t.readerId},ExpressionAttributeValues:{":status":n},UpdateExpression:"SET transcribeStatus = :status"};r.push(this.dynamo.update(s))}),Promise.all(r)})}}},22:function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var r=n(23),s=n.n(r);const i=n(3);class o{constructor(e,t){this.transcribe=e,this.encrypt=t}}class a{constructor(e,t,n){this.transcription=e,this.preSignedUrl=t,this.audioFile=n}}class c{constructor(e,t){this.s3Service=e,this.transcriptionService=t,this.ses=new i.SES,this.sns=new i.SNS,this.transporter=s.a.createTransport({SES:this.ses}),this.recordingExpiration=parseInt(process.env.SIGNED_RECORDING_URL_EXP)}deliver(e,t,n){let r=this.getTranscribeAndEncryptionSettings(e,t),s=n.agent.deliveryOptions,i=s.email,o=s.sms.enabled,a=n.connectUser.email||n.connectUser.username,c=s.sms.phoneNumber,l=e.deliveryEmail;if(!l)throw"You must provide a delivery email";return i||o?i&&o?(console.log("Should Send BOTH email and SMS"),this.getDeliveryContents(r,t).then(e=>this.sendTextMessage(t,c,e).then(()=>this.sendMail(t,l,a,e)))):o&&c?(console.log("Send ONLY SMS"),Promise.resolve()):s.email?(console.log("Send ONLY Email"),this.getDeliveryContents(r,t).then(e=>this.sendMail(t,l,a,e))):Promise.resolve({message:"Undeliverable"}):(console.log("NOT sending email or sms"),Promise.resolve({message:"Not sending Email or SNS"}))}getDeliveryContents(e,t){console.log("Getting Delivery Contents");let n=Promise.resolve(null),r=Promise.resolve(null),s=Promise.resolve(null);if(e.encrypt?(console.log("Encrypt..."),r=this.s3Service.getPreSignedUrl(t.recordingBucketName,t.recordingObjectKey,this.recordingExpiration)):(console.log("Unencrypted..."),s=this.s3Service.getFile(t.recordingBucketName,t.recordingObjectKey)),e.transcribe){console.log("Transcribe...");let e=t.getTranscriptJobName();n=this.transcriptionService.getTranscriptForJobName(e)}return Promise.all([n,r,s]).then(e=>{let t=e[0],n=e[1],r=e[2];return new a(t,n,r)})}sendMail(e,t,n,r){return new Promise((s,i)=>{let o=`<p>${new Date(1e3*e.timestamp)}</p>`;if(o+=`<p>New voicemail from ${e.contactPhoneNumber}.</p>`,r.transcription&&(o+=`<b>Voicemail Transcript:</b><p>${r.transcription.transcripts[0].transcript}</p>`),o+="<b>Voicemail:</b>",r.preSignedUrl){o+=`<p>Voicemail Expiration Date: ${new Date(1e3*Math.floor(Date.now()/1e3+r.preSignedUrl.expires))}</p>`,o+=`<p><a href="${r.preSignedUrl.url}">Click Here</a> to listen to the voicemail</p>`}let a={from:t,subject:`New voicemail from ${e.contactPhoneNumber}`,html:o,to:n};r.audioFile&&(a.attachments=[{filename:"voicemail.wav",content:r.audioFile.Body}]),this.transporter.sendMail(a,(e,t)=>{if(e)return console.log(e),void i(e);s(t)})})}sendTextMessage(e,t,n){return new Promise((r,s)=>{let i=`Amazon Connect voicemail from ${e.contactPhoneNumber}\n`;if(n.transcription&&(i+=`\nTranscript: "${n.transcription.transcripts[0].transcript}"\n`),n.preSignedUrl){i+=`\nVoicemail Expiration Date: ${new Date(1e3*Math.floor(Date.now()/1e3+n.preSignedUrl.expires))}\n`,i+=`${n.preSignedUrl.url}`}let o={Message:i,PhoneNumber:t};this.sns.publish(o,(e,t)=>{e&&console.log(`Error: ${e}`),r(t)})})}getTranscribeAndEncryptionSettings(e,t){let n=!1,r=!0;return!0===e.transcribeVoicemail&&(n=t.shouldTranscribe),!1===e.encryptVoicemail&&(r=t.shouldEncrypt),new o(n,r)}}},23:function(e,t){e.exports=require("nodemailer")},24:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));const r=n(3);class s{constructor(){this.s3=new r.S3}getFile(e,t){let n={Bucket:e,Key:t};return this.s3.getObject(n).promise()}getPreSignedUrl(e,t,n=900){return new Promise((r,s)=>{let i={Bucket:e,Key:t,Expires:n};return this.s3.getSignedUrl("getObject",i,(e,t)=>{e?s(e):r({url:t,expires:n})})})}}},25:function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var r=n(26),s=n.n(r);const i=n(3);class o{constructor(){this.transcribe=new i.TranscribeService}getTranscriptForJobName(e){let t={TranscriptionJobName:e};return this.transcribe.getTranscriptionJob(t).promise().then(e=>{let t={method:"GET",uri:e.TranscriptionJob.Transcript.TranscriptFileUri,json:!0};return s()(t).then(t=>({transcriptionJob:e,transcripts:t.results.transcripts||null}))}).catch(e=>{console.log(e)})}}},26:function(e,t){e.exports=require("request-promise")},27:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));class r{constructor(e){this.contactId=e.contactId,this.timestamp=e.timestamp,this.agentId=e.readerId,this.contactPhoneNumber=e.contactPhoneNumber,this.shouldTranscribe=e.shouldTranscribe||!1,this.shouldEncrypt=e.shouldEncrypt||!1,this.transcribeStatus=e.transcribeStatus,this.recordingUrl=e.recordingUrl,this.recordingBucketName=e.recordingBucketName,this.recordingObjectKey=e.recordingObjectKey,this.recordingBucketRegion=e.recordingBucketRegion}getTranscriptJobName(){return`${this.contactId}_${this.timestamp}`}}class s{constructor(e,t,n,r){this.voicemailRepo=e,this.agentService=t,this.notificationService=n,this.globalSettingsService=r}updateVoicemailTranscriptStatus(e,t){let n=e.split("_"),r=n[0],s=parseInt(n[1]);return this.voicemailRepo.updateTranscriptionStatus(r,s,t)}processVoicemailRecords(e,t,n){console.log("Processing Voicemail Recording");let s=new r(t);return"IN_PROGRESS"===new r(n).transcribeStatus&&"COMPLETED"===s.transcribeStatus||null===s.transcribeStatus||void 0===s.transcribeStatus?this._deliver(s):Promise.resolve({message:"Unhandled Resolution"})}_deliver(e){return Promise.all([this.globalSettingsService.getSettings(),this.agentService.getConnectAgentByUserId(e.agentId)]).then(t=>{let n=t[0],r=t[1];return this.notificationService.deliver(n,e,r)})}}},3:function(e,t){e.exports=require("aws-sdk")},4:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));const r=n(3);class s{constructor(e){this.tableName=e,this.client=new r.DynamoDB.DocumentClient}update(e){return e.TableName=this.tableName,e.ReturnValues="ALL_NEW",this.client.update(e).promise()}put(e){return e.TableName=this.tableName,this.client.put(e).promise()}query(e){return e.TableName=this.tableName,this.client.query(e).promise().then(e=>e.Items||null)}scan(e){return e.TableName=this.tableName,this.client.scan(e).promise().then(e=>e.Items||null)}queryWithNext(e){return e.TableName=this.tableName,this.client.query(e).promise().then(e=>{let t={data:e.Items||[]};return e.LastEvaluatedKey&&(t.next=Buffer.from(JSON.stringify(e.LastEvaluatedKey),"utf8").toString("base64")),t})}scanWithNext(e){return e.TableName=this.tableName,this.client.scan(e).promise().then(e=>{let t={data:e.Items||[]};return e.LastEvaluatedKey&&(t.next=Buffer.from(JSON.stringify(e.LastEvaluatedKey),"utf8").toString("base64")),t})}getItem(e,t){return e.TableName=this.tableName,this.client.get(e).promise().then(e=>e.Item||null)}batchWrite(e,t){return new Promise((n,r)=>{this._batchWrite(e,t).then(t=>{e.length>t.index?this.batchWrite(e,t.index).then(e=>{n(e)}):n(t.data)})})}_batchWrite(e,t){return new Promise((n,r)=>{let s=e.length>t+24?t+24:e.length,i=e.slice(t,s),o={RequestItems:{[this.tableName]:i}};this.client.batchWrite(o,(e,r)=>{e&&console.log("Any error? "+JSON.stringify(e,null,2)),n({index:t+24,data:r})})})}}},5:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));class r{constructor(e){this.userId=e.userId,this.extension=e.extension,this.username=e.username,this.transcribeVoicemail=e.transcribeVoicemail||!1,this.encryptVoicemail=e.encryptVoicemail||!1,this.deliveryOptions=e.deliveryOptions||{sms:{enabled:!1,phoneNumber:null},email:!1}}static create(e,t=null){return new r({userId:e,extension:t,deliveryOptions:{sms:{enabled:!1,phoneNumber:null},email:!1}})}}},885:function(e,t,n){"use strict";n.r(t);var r=n(22),s=n(12),i=n(21),o=n(27),a=n(10),c=n(13),l=n(24),u=n(25),d=n(11),h=n(14);const m=n(3),p=new a.a,g=new h.a,b=new o.a(new i.a,new s.a(new c.a,p),new r.a(new l.a,new u.a),new d.a(g));exports.stream=async(e,t)=>{let{Records:n}=e,r=n.map(async e=>{let t=e.eventName,n=m.DynamoDB.Converter.unmarshall(e.dynamodb.NewImage),r=m.DynamoDB.Converter.unmarshall(e.dynamodb.OldImage);return await b.processVoicemailRecords(t,n,r)});try{await Promise.all(r);return{lambdaResult:"Success"}}catch(e){return console.log(e),{error:e}}}},9:function(e,t){e.exports=require("awesome-phonenumber")}}));
//# sourceMappingURL=voicemail.js.map